<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeTV Restream Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --bg-card-hover: #1f2a3f;
            --accent: #f59e0b;
            --accent-dim: #b45309;
            --green: #22c55e;
            --red: #ef4444;
            --text: #e5e7eb;
            --text-dim: #6b7280;
            --text-bright: #f9fafb;
            --border: #2d3748;
            --radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .logo span { color: var(--text-dim); font-weight: 400; }

        .stats-bar {
            display: flex;
            gap: 24px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .stat-dot.green { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .stat-dot.red { background: var(--red); box-shadow: 0 0 8px var(--red); }
        .stat-dot.amber { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

        /* Search & Tabs */
        .toolbar {
            padding: 16px 24px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 16px 10px 40px;
            color: var(--text);
            font-size: 14px;
            font-family: 'Nunito', sans-serif;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .tab-group {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 3px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            border-radius: 7px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Nunito', sans-serif;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text);
            background: var(--bg-card-hover);
        }

        /* Channel Grid */
        .channels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            padding: 0 24px 24px;
        }

        .channel-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .channel-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-dim);
            transform: translateY(-1px);
        }

        .channel-card.running::before {
            content: "";
            position: absolute;
            top: 0; left: 0;
            width: 3px; height: 100%;
            background: var(--green);
        }

        .channel-card.stopped::before {
            content: "";
            position: absolute;
            top: 0; left: 0;
            width: 3px; height: 100%;
            background: var(--red);
        }

        .ch-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .ch-name {
            font-weight: 700;
            font-size: 15px;
            color: var(--text-bright);
            line-height: 1.3;
        }

        .ch-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .ch-status.on { background: #16532c; color: #4ade80; }
        .ch-status.off { background: #532020; color: #f87171; }

        .ch-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-dim);
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
        }

        .ch-actions {
            display: flex;
            gap: 6px;
        }

        .ch-btn {
            flex: 1;
            padding: 7px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-dim);
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            transition: all 0.15s;
            text-align: center;
        }

        .ch-btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .ch-btn.play-btn:hover { background: var(--green); border-color: var(--green); }
        .ch-btn.stop-btn:hover { background: var(--red); border-color: var(--red); }

        /* Video Player Modal */
        .player-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .player-overlay.active { display: flex; }

        .player-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            overflow: hidden;
        }

        .player-header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .player-title {
            font-weight: 700;
            font-size: 18px;
            color: var(--text-bright);
        }

        .player-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: 0.2s;
        }

        .player-close:hover { background: var(--bg-card); color: var(--text); }

        .player-video {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
        }

        .player-info {
            padding: 12px 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-dim);
            display: flex;
            gap: 16px;
            align-items: center;
            border-top: 1px solid var(--border);
        }

        .player-url {
            flex: 1;
            background: var(--bg-card);
            padding: 8px 12px;
            border-radius: 6px;
            word-break: break-all;
            color: var(--accent);
        }

        .copy-btn {
            padding: 8px 16px;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 12px;
            transition: 0.15s;
            white-space: nowrap;
        }

        .copy-btn:hover { background: #fbbf24; }
        .copy-btn.copied { background: var(--green); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            z-index: 300;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show { transform: translateY(0); opacity: 1; }

        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 12px; }
            .stats-bar { flex-wrap: wrap; }
            .channels-grid { grid-template-columns: 1fr; }
            .player-container { width: 95%; }
        }

        /* Loading */
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .loading-text {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-dim);
            animation: pulse 1.5s infinite;
            padding: 40px;
            text-align: center;
        }
    </style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="header-left">
        <div class="logo">BeeTV<span> // restream</span></div>
    </div>
    <div class="stats-bar" id="statsBar">
        <div class="stat-item"><span class="stat-dot green"></span> <span id="statRunning">-</span> active</div>
        <div class="stat-item"><span class="stat-dot amber"></span> <span id="statSegments">-</span> segs</div>
        <div class="stat-item"><span class="stat-dot red"></span> <span id="statErrors">-</span> errs</div>
        <div class="stat-item">üë• <span id="statClients">-</span></div>
    </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–∞..." autocomplete="off">
    </div>
    <div class="tab-group">
        <button class="tab-btn active" data-filter="all">–í—Å–µ</button>
        <button class="tab-btn" data-filter="running">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
        <button class="tab-btn" data-filter="stopped">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</button>
    </div>
</div>

<!-- Channel Grid -->
<div class="channels-grid" id="channelsGrid">
    <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤...</div>
</div>

<!-- Video Player Overlay -->
<div class="player-overlay" id="playerOverlay">
    <div class="player-container">
        <div class="player-header">
            <div class="player-title" id="playerTitle">–ö–∞–Ω–∞–ª</div>
            <button class="player-close" id="playerClose">&times;</button>
        </div>
        <video class="player-video" id="playerVideo" controls autoplay muted></video>
        <div class="player-info">
            <div class="player-url" id="playerUrl"></div>
            <button class="copy-btn" id="copyUrlBtn">COPY URL</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const API_BASE = '';
let channels = [];
let currentFilter = 'all';
let searchQuery = '';

// ============================================================
// API
// ============================================================
async function fetchChannels() {
    try {
        const resp = await fetch(`${API_BASE}/api/channels`);
        channels = await resp.json();
        renderChannels();
        updateStats();
    } catch (e) {
        console.error('Failed to fetch channels:', e);
    }
}

async function fetchStats() {
    try {
        const resp = await fetch(`${API_BASE}/api/stats`);
        const data = await resp.json();
        document.getElementById('statRunning').textContent = data.running_channels;
        document.getElementById('statSegments').textContent = formatNum(data.total_segments);
        document.getElementById('statErrors').textContent = formatNum(data.total_errors);
        document.getElementById('statClients').textContent = data.total_clients;
    } catch (e) {}
}

async function startChannel(channelId) {
    await fetch(`${API_BASE}/api/channels/${channelId}/start`, { method: 'POST' });
    showToast('–ö–∞–Ω–∞–ª –∑–∞–ø—É—â–µ–Ω');
    setTimeout(fetchChannels, 1000);
}

async function stopChannel(channelId) {
    await fetch(`${API_BASE}/api/channels/${channelId}/stop`, { method: 'POST' });
    showToast('–ö–∞–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    setTimeout(fetchChannels, 1000);
}

// ============================================================
// Rendering
// ============================================================
function renderChannels() {
    const grid = document.getElementById('channelsGrid');
    
    let filtered = channels.filter(ch => {
        if (currentFilter === 'running' && !ch.running) return false;
        if (currentFilter === 'stopped' && ch.running) return false;
        if (searchQuery) {
            const q = searchQuery.toLowerCase();
            return ch.name.toLowerCase().includes(q) || ch.channel_id.includes(q);
        }
        return true;
    });
    
    if (filtered.length === 0) {
        grid.innerHTML = '<div class="loading-text">–ö–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }
    
    grid.innerHTML = filtered.map(ch => `
        <div class="channel-card ${ch.running ? 'running' : 'stopped'}" data-id="${ch.channel_id}">
            <div class="ch-header">
                <div class="ch-name">${escHtml(ch.name)}</div>
                <div class="ch-status ${ch.running ? 'on' : 'off'}">${ch.running ? 'LIVE' : 'OFF'}</div>
            </div>
            <div class="ch-meta">
                <span>ID: ${ch.channel_id}</span>
                <span>Segs: ${ch.segments}</span>
                ${ch.clients > 0 ? `<span>üë• ${ch.clients}</span>` : ''}
                ${ch.errors > 0 ? `<span style="color:#f87171">Err: ${ch.errors}</span>` : ''}
            </div>
            <div class="ch-actions">
                <button class="ch-btn play-btn" onclick="event.stopPropagation(); startChannel('${ch.channel_id}')">‚ñ∂ START</button>
                <button class="ch-btn stop-btn" onclick="event.stopPropagation(); stopChannel('${ch.channel_id}')">‚ñ† STOP</button>
                <button class="ch-btn" onclick="event.stopPropagation(); copyStreamUrl('${ch.channel_id}', '${escAttr(ch.name)}')">üìã URL</button>
                <button class="ch-btn" onclick="event.stopPropagation(); openPlayer('${ch.channel_id}', '${escAttr(ch.name)}')">üì∫ PLAY</button>
            </div>
        </div>
    `).join('');
}

function updateStats() {
    let running = 0, totalSegs = 0, totalErr = 0, totalClients = 0;
    channels.forEach(ch => {
        if (ch.running) running++;
        totalSegs += ch.segments;
        totalErr += ch.errors;
        totalClients += ch.clients;
    });
    document.getElementById('statRunning').textContent = running;
    document.getElementById('statSegments').textContent = formatNum(totalSegs);
    document.getElementById('statErrors').textContent = formatNum(totalErr);
    document.getElementById('statClients').textContent = totalClients;
}

// ============================================================
// Player
// ============================================================
function openPlayer(channelId, name) {
    const overlay = document.getElementById('playerOverlay');
    const video = document.getElementById('playerVideo');
    const title = document.getElementById('playerTitle');
    const urlBox = document.getElementById('playerUrl');
    
    const streamUrl = `${window.location.origin}/stream/${channelId}`;
    
    title.textContent = name;
    urlBox.textContent = streamUrl;
    video.src = streamUrl;
    
    overlay.classList.add('active');
}

function closePlayer() {
    const overlay = document.getElementById('playerOverlay');
    const video = document.getElementById('playerVideo');
    video.pause();
    video.src = '';
    overlay.classList.remove('active');
}

function copyStreamUrl(channelId, name) {
    const url = `${window.location.origin}/stream/${channelId}`;
    navigator.clipboard.writeText(url).then(() => {
        showToast(`URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ${name}`);
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = url;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast(`URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ${name}`);
    });
}

// ============================================================
// UI helpers
// ============================================================
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

function formatNum(n) {
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
    return n.toString();
}

function escHtml(s) { 
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function escAttr(s) {
    return s.replace(/'/g, "\\'").replace(/"/g, "&quot;");
}

// ============================================================
// Events
// ============================================================
document.getElementById('searchInput').addEventListener('input', (e) => {
    searchQuery = e.target.value;
    renderChannels();
});

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderChannels();
    });
});

document.getElementById('playerClose').addEventListener('click', closePlayer);
document.getElementById('playerOverlay').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closePlayer();
});

document.getElementById('copyUrlBtn').addEventListener('click', () => {
    const url = document.getElementById('playerUrl').textContent;
    navigator.clipboard.writeText(url);
    const btn = document.getElementById('copyUrlBtn');
    btn.textContent = 'COPIED!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'COPY URL'; btn.classList.remove('copied'); }, 2000);
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closePlayer();
});

// ============================================================
// Init
// ============================================================
fetchChannels();
setInterval(fetchChannels, 5000);
</script>

</body>
</html>
